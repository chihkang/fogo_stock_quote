# 專案優化計畫

本計畫旨在針對當前專案進行優化, 提高程式碼的可讀性、可維護性和效能。

## 1. config.py

*   **環境變數驗證**:
    *   目前的環境變數驗證方式是透過 `Config.validate_env()` 類別方法進行。
    *   建議使用 `pydantic` 或 `dataclasses` 等庫來定義配置類別, 並使用這些庫提供的驗證功能來驗證環境變數。
    *   這樣可以更方便地定義和驗證配置資訊, 並提供更好的型別提示。
*   **配置初始化**:
    *   目前的配置初始化方式是在檔案底部直接呼叫 `Config.get_env()` 方法來獲取環境變數的值, 並將其賦值給全域變數。
    *   建議使用 `pydantic` 或 `dataclasses` 等庫來定義配置類別, 並在程式啟動時實例化這個類別。
    *   這樣可以更方便地管理配置資訊, 並避免使用全域變數。
*   **REQUEST\_TIMEOUT**:
    *   目前的 `REQUEST_TIMEOUT` 設定為 (3.05, 27)。
    *   建議將這個設定也放在環境變數中, 方便調整。

## 2. update_scheduler.py

*   **重複程式碼**:
    *   `update_taiwan_stocks` 和 `update_us_stocks` 函數有很多重複的程式碼。
    *   建議將這些重複的程式碼提取到一個通用的函數中, 並將股票類型 (台股或美股) 作為參數傳遞給這個函數。
*   **錯誤處理**:
    *   目前的錯誤處理方式是在 `process` 函數中, 如果無法取得股價或 stock\_id, 則記錄錯誤訊息。
    *   建議使用 `try...except` 結構來捕獲異常, 並進行更詳細的錯誤處理, 例如重試或發送警報。
*   **交易時間判斷**:
    *   目前的交易時間判斷是在迴圈中針對每個股票進行的。
    *   建議在迴圈之前先判斷一次交易時間, 如果不是交易時間, 則直接跳過整個更新過程。
*   **股票清單**:
    *   目前的股票清單是透過 `fetch_stock_list()` 函數獲取的。
    *   建議將股票清單儲存在一個檔案中, 程式啟動時先檢查檔案是否存在, 如果存在則從檔案中讀取股票清單, 否則從 API 獲取股票清單並儲存到檔案中。

## 3. stock_service.py

*   **重複程式碼**:
    *   `fetch_taiwan_stock_quote` 和 `fetch_us_stock_quote` 函數有很多重複的程式碼。
    *   建議將這些重複的程式碼提取到一個通用的函數中, 並將 API URL 和 API 金鑰作為參數傳遞給這個函數。
*   **錯誤處理**:
    *   目前的錯誤處理方式是在 `try...except` 區塊中記錄錯誤訊息並返回 `None`。
    *   建議定義一個自定義的異常類別, 並在 `except` 區塊中拋出這個異常。
    *   這樣可以更方便地處理錯誤, 並提供更詳細的錯誤資訊。
*   **aiohttp.ClientSession**:
    *   目前在每個函數中都創建了一個新的 `aiohttp.ClientSession`。
    *   建議創建一個全域的 `aiohttp.ClientSession` 物件, 並在程式啟動時初始化它, 在程式結束時關閉它。
    *   這樣可以避免重複創建和銷毀 `ClientSession` 物件, 提高效能。
*   **MINIMAL\_API\_URL**:
    *   `fetch_stock_list` 和 `get_stock_id` 函數都使用了 `MINIMAL_API_URL`。
    *   建議將這兩個函數合併成一個函數, 並一次性獲取股票清單和 stock\_id。
*   **股票清單解析**:
    *   `fetch_stock_list` 函數中, 使用 `item["name"].split(":")` 來解析股票名稱。
    *   這種方式比較脆弱, 如果股票名稱的格式發生變化, 可能會導致程式崩潰。
    *   建議使用更健壯的方式來解析股票名稱, 例如使用正則表達式。

## 4. trading_time.py

*   **夏令時間**:
    *   `is_trading_time_us` 函數未考慮美股夏令時間 (DST) 的影響。
    *   建議根據東部時間動態轉換, 以正確計算美股的交易時間。
*   **交易時間判斷**:
    *   `is_trading_time_us` 函數的邏輯比較複雜。
    *   建議使用更簡潔的方式來判斷交易時間, 例如使用 `datetime.time` 物件。
*   **重複程式碼**:
    *   `is_trading_time_taiwan` 和 `is_trading_time_us` 函數有一些重複的程式碼。
    *   建議將這些重複的程式碼提取到一個通用的函數中, 並將交易時間的起始和結束時間作為參數傳遞給這個函數。

## 5. main.py

*   **錯誤處理**:
    *   目前的錯誤處理方式是直接呼叫 `sys.exit(1)` 退出程式。
    *   建議使用 `try...except...finally` 結構, 在 `finally` 區塊中執行清理工作。
*   **排程器配置**:
    *   目前的排程器是在程式碼中配置的。
    *   建議將排程器的配置資訊放在配置檔案中, 例如 `config.py`。
*   **更新間隔**:
    *   目前台股每 2 分鐘更新一次, 美股每 5 分鐘更新一次。
    *   建議將這些更新間隔也放在配置檔案中, 方便調整。
*   **無限迴圈**:
    *   目前使用 `while True` 建立無限迴圈, 然後使用 `time.sleep(60)` 讓程式休眠。
    *   建議讓 APScheduler 直接管理程式的生命週期, 避免使用無限迴圈。